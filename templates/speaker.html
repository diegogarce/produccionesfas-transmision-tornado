<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage Monitor · {{ user_name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        navy: {
                            950: '#050511',
                            900: '#0a0b16',
                            800: '#151725',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050511;
        }

        .scroll-area::-webkit-scrollbar {
            width: 0px;
        }

        .animate-in {
            animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes highlight {
            0% {
                transform: scale(0.95);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .new-highlight {
            animation: highlight 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
    </style>
</head>

<body class="bg-[#050511] text-slate-100 min-h-screen overflow-hidden">
    <div class="h-screen flex flex-col p-8 lg:p-12 relative text-white">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl h-64 bg-indigo-500/10 blur-[120px] -z-10">
        </div>

        <header class="flex items-center justify-between mb-12 animate-in">
            <div class="flex items-center">
                <img src="https://produccionesfast.com/assets/img/logo.png" alt="Producciones Fast"
                    class="h-8 w-auto drop-shadow-2xl">
                <div class="h-8 w-px bg-white/10 mx-6 hidden sm:block"></div>
                <span class="text-[10px] font-bold tracking-[0.2em] text-indigo-400 uppercase hidden sm:block">Stage
                    Monitor</span>
                <div class="h-8 w-px bg-white/10 mx-6 hidden sm:block"></div>
                <div class="flex items-center gap-2">
                    <span class="relative flex h-2.5 w-2.5">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500"></span>
                    </span>
                    <span class="text-[10px] font-bold tracking-[0.3em] text-red-500 uppercase">Live Session</span>
                </div>
            </div>
            <div class="flex items-center gap-8 text-right">
                <div class="hidden md:block text-white">
                    <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1">Speaker en Escena
                    </p>
                    <p class="text-xl font-medium">{{ user_name }}</p>
                </div>
                <a href="/logout"
                    class="bg-white/5 hover:bg-white/10 p-3 rounded-xl border border-white/10 transition-all">
                    <svg class="w-6 h-6 text-slate-400 hover:text-white" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                </a>
            </div>
        </header>

        <main class="flex-1 flex flex-col lg:flex-row gap-12 overflow-hidden">
            <div class="flex-[1.5] flex flex-col justify-center">
                <p class="text-xs font-black text-indigo-500 uppercase tracking-[0.5em] mb-4 animate-in">Pregunta Actual
                </p>
                <div id="current-question-container" class="animate-in min-h-[400px]">
                    <div class="opacity-10 py-20">
                        <h2 class="text-6xl lg:text-8xl font-black text-white leading-tight">Esperando<br>interacción...
                        </h2>
                    </div>
                </div>
            </div>

            <div
                class="flex-1 flex flex-col h-full bg-white/[0.02] border border-white/5 rounded-[2.5rem] p-8 backdrop-blur-3xl lg:max-w-md animate-in">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-xs font-bold uppercase tracking-widest text-slate-500">Próximas en cola</h2>
                    <span id="queue-count"
                        class="bg-indigo-500/10 text-indigo-400 text-[10px] font-black px-3 py-1 rounded-full border border-indigo-500/20">0</span>
                </div>

                <div id="speaker-questions" class="flex-1 overflow-y-auto space-y-6 scroll-area pr-2">
                    {% for question in approved_questions %}
                    <div class="p-6 rounded-2xl bg-white/5 border border-white/5 opacity-50 transition-all hover:opacity-100 group cursor-pointer"
                        onclick="highlightManual('{{ question.get('id', '') }}')" data-id="{{ question.get('id', '') }}"
                        data-user="{{ question.get('user_name', '') }}"
                        data-question="{{ question.get('question_text', '') }}"
                        data-timestamp="{{ question.get('created_at', '') }}">
                        <p
                            class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-2 group-hover:translate-x-1 transition-transform">
                            {{ question.get('user_name', '') }}</p>
                        <p class="text-lg text-slate-200 font-medium leading-relaxed">{{ question.get('question_text',
                            '') }}</p>
                    </div>
                    {% end %}
                </div>
            </div>
        </main>
    </div>

    <script>
        // Dynamically determine protocol (ws or wss) based on page loading environment
        const baseWsUrl = "{% raw ws_url %}";
        const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const finalWsUrl = baseWsUrl.replace(/^ws(s)?:\/\//, wsProtocol);
        const ws = new WebSocket(finalWsUrl);
        const list = document.getElementById("speaker-questions");
        const currentContainer = document.getElementById("current-question-container");
        const queueCount = document.getElementById("queue-count");

        let currentActiveId = null;
        let wsConnected = false;

        // WebSocket connection handlers
        ws.addEventListener("open", () => {
            console.log("✓ Speaker WebSocket Connected");
            wsConnected = true;
        });

        ws.addEventListener("close", (e) => {
            console.log("✗ Speaker WebSocket Closed:", e.code, e.reason);
            wsConnected = false;
            // Try to reconnect after 3 seconds
            setTimeout(() => location.reload(), 3000);
        });

        ws.addEventListener("error", (e) => {
            console.error("✗ Speaker WebSocket Error:", e);
            wsConnected = false;
        });

        function updateCurrent(payload) {
            currentActiveId = payload.id;
            currentContainer.innerHTML = `
                <div class="new-highlight">
                    <div class="flex items-center justify-between mb-8">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-indigo-500 flex items-center justify-center text-lg font-bold shadow-lg">
                                ${payload.user.slice(0, 2).toUpperCase()}
                            </div>
                            <div>
                                <p class="text-xl font-bold text-white">${payload.user}</p>
                                <p class="text-[10px] text-indigo-400 font-bold uppercase tracking-[0.2em]">Enviada a las ${payload.timestamp}</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                             <button onclick="returnToModerator(${payload.id})" 
                                class="bg-white/5 hover:bg-amber-500/20 text-amber-500 hover:text-amber-400 px-4 py-2 rounded-xl border border-white/10 hover:border-amber-500/30 transition-all text-[10px] font-black tracking-widest flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                                REGRESAR
                            </button>
                            <button onclick="markAsRead(${payload.id})" 
                                class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-xl shadow-lg shadow-indigo-600/20 transition-all text-[10px] font-black tracking-widest flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                LEÍDA
                            </button>
                        </div>
                    </div>
                    <h2 class="text-4xl lg:text-7xl font-black text-white leading-[1.1] tracking-tight">
                        ${payload.question}
                    </h2>
                </div>
            `;
            syncQueueList();
        }

        function syncQueueList() {
            const items = list.querySelectorAll("[data-id]");
            let visibleCount = 0;
            items.forEach(el => {
                if (el.dataset.id == currentActiveId) {
                    el.classList.add("hidden");
                } else {
                    el.classList.remove("hidden");
                    visibleCount++;
                }
            });
            queueCount.innerText = visibleCount;
        }

        function markAsRead(id) {
            if (!wsConnected) {
                console.error("Cannot send: WebSocket not connected");
                alert("Conexión perdida. Recargando página...");
                location.reload();
                return;
            }
            console.log("Sending read for id:", id);
            ws.send(JSON.stringify({ type: "read", id: parseInt(id) }));
        }

        function returnToModerator(id) {
            if (!wsConnected) {
                console.error("Cannot send: WebSocket not connected");
                alert("Conexión perdida. Recargando página...");
                location.reload();
                return;
            }
            console.log("Sending return_to_moderator for id:", id);
            ws.send(JSON.stringify({ type: "return_to_moderator", id: parseInt(id) }));
        }

        function highlightManual(id) {
            const el = list.querySelector(`[data-id="${id}"]`);
            if (!el) return;
            updateCurrent({
                id: id,
                user: el.dataset.user,
                question: el.dataset.question,
                timestamp: el.dataset.timestamp
            });
        }

        function updateNextInQueue() {
            const items = Array.from(list.querySelectorAll("[data-id]"));
            if (items.length > 0) {
                const first = items[0];
                updateCurrent({
                    id: first.dataset.id,
                    user: first.dataset.user,
                    question: first.dataset.question,
                    timestamp: first.dataset.timestamp
                });
            } else {
                currentActiveId = null;
                currentContainer.innerHTML = `
                    <div class="opacity-10 py-20">
                        <h2 class="text-6xl lg:text-8xl font-black text-white leading-tight">Sin<br>preguntas</h2>
                    </div>
                `;
                queueCount.innerText = 0;
            }
        }

        ws.addEventListener("message", (event) => {
            const payload = JSON.parse(event.data);
            console.log("WS Message:", payload.type, payload);

            if (payload.type === "approved_question") {
                const div = document.createElement("div");
                div.className = "p-6 rounded-2xl bg-white/5 border border-white/5 animate-in group cursor-pointer";
                div.dataset.id = payload.id;
                div.dataset.user = payload.user;
                div.dataset.question = payload.question;
                div.dataset.timestamp = payload.timestamp;
                div.onclick = () => highlightManual(payload.id);
                div.innerHTML = `
                    <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-2">${payload.user}</p>
                    <p class="text-lg text-slate-200 font-medium leading-relaxed">${payload.question}</p>
                `;
                list.prepend(div);
                if (!currentActiveId) {
                    updateCurrent(payload);
                } else {
                    syncQueueList();
                }
            } else if (payload.type === "question_read" || payload.type === "question_removed") {
                const el = list.querySelector(`[data-id="${payload.id}"]`);
                if (el) el.remove();

                if (currentActiveId == payload.id) {
                    updateNextInQueue();
                } else {
                    syncQueueList();
                }
            } else if (payload.type === "event_closed") {
                window.location.href = "/?error=" + encodeURIComponent("Esta transmisión ha finalizado.");
            }
        });

        // Initial setup
        updateNextInQueue();
    </script>
</body>

</html>
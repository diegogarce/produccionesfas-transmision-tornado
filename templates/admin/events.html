<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Eventos · Producciones Fast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        navy: {
                            950: '#050511', // Deepest background
                            900: '#0a0b16', // Surface
                            800: '#151725', // Lighter Surface
                            700: '#1f2236', // Borders
                        },
                        brand: {
                            blue: '#4f46e5', // Brand primary based on "Live Platform"
                            accent: '#6366f1',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(5px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050511;
        }

        .glass-panel {
            background: rgba(10, 11, 22, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .nav-link {
            position: relative;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 0%;
            height: 2px;
            background-color: #4f46e5;
            transition: width 0.3s ease;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        /* Custom SweetAlert2 Dark Theme Override */
        div:where(.swal2-container).swal2-center>.swal2-popup {
            background: #0a0b16 !important;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
        }

        div:where(.swal2-container) .swal2-title {
            color: #fff !important;
            font-family: 'Inter', sans-serif !important;
        }

        div:where(.swal2-container) .swal2-html-container {
            color: #94a3b8 !important;
            font-family: 'Inter', sans-serif !important;
        }

        div:where(.swal2-icon).swal2-warning {
            border-color: #f59e0b !important;
            color: #f59e0b !important;
        }

        div:where(.swal2-icon).swal2-question {
            border-color: #6366f1 !important;
            color: #6366f1 !important;
        }
    </style>
    {% include "../includes/toast.html" %}
</head>

<body class="text-slate-300 min-h-screen antialiased">

    <!-- Top Navigation Bar (Matching Identity) -->
    <nav class="border-b border-white/5 bg-[#050511]/90 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">
            <!-- Left Side: Logo | Platform Name -->
            <div class="flex items-center h-full">
                <img src="https://produccionesfast.com/assets/img/logo.png" alt="Producciones Fast"
                    class="h-6 w-auto opacity-90 hover:opacity-100 transition-opacity">

                <div class="h-8 w-px bg-white/10 mx-4 sm:mx-6 hidden sm:block"></div>

                <span class="text-[10px] font-bold tracking-[0.2em] text-slate-500 uppercase hidden sm:block">Admin
                    Console</span>

            </div>

            <!-- Desktop Menu -->
            <div class="hidden md:flex items-center gap-6">
                <button onclick="openModal()"
                    class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all shadow-lg shadow-indigo-600/20 hover:shadow-indigo-600/40 border border-indigo-500/50 hover:-translate-y-0.5">
                    + Nuevo
                </button>

                <span class="text-sm font-medium text-slate-400">Admin User</span>

                <a href="/logout" class="text-slate-500 hover:text-white transition-colors" title="Cerrar Sesión">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </a>
            </div>

            <!-- Mobile Menu Button -->
            <button onclick="toggleMobileMenu()" class="md:hidden text-slate-400 hover:text-white transition-colors p-2"
                id="mobile-menu-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="menu-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
                <svg class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="close-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Mobile Menu Panel -->
        <div class="hidden md:hidden border-t border-white/5 bg-[#050511]" id="mobile-menu">
            <div class="px-4 py-4 space-y-4">
                <button onclick="openModal(); toggleMobileMenu();"
                    class="w-full bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-3 rounded-lg text-sm font-bold uppercase tracking-widest transition-all">
                    + Nuevo Evento
                </button>

                <div class="border-t border-white/10 pt-4">
                    <span class="text-sm font-medium text-slate-400 block mb-3">Admin User</span>
                    <a href="/logout"
                        class="flex items-center gap-3 text-slate-400 hover:text-white transition-colors py-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        Cerrar Sesión
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <script>
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');
            const closeIcon = document.getElementById('close-icon');

            menu.classList.toggle('hidden');
            menuIcon.classList.toggle('hidden');
            closeIcon.classList.toggle('hidden');
        }
    </script>

    <div class="max-w-7xl mx-auto px-6 py-10">
        <!-- Page Title & Stats -->
        <div class="mb-12 animate-fade-in">
            <h1 class="text-3xl font-bold text-white mb-2">Mis Eventos</h1>
            <p class="text-slate-500">Administra y monitorea todas tus transmisiones activas.</p>
        </div>

        <!-- Events Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
            {% for event in events %}
            <!-- Event Card -->
            <div
                class="bg-navy-900 border border-white/5 rounded-2xl overflow-hidden hover:border-indigo-500/30 transition-all duration-300 group hover:-translate-y-1 hover:shadow-xl shadow-black/40 animate-fade-in">
                <!-- Status Bar -->
                <div class="px-6 py-4 border-b border-white/5 flex items-center justify-between bg-navy-800/50">
                    <div class="flex items-center gap-2">
                        {% if event['is_active'] %}
                        <span class="relative flex h-2.5 w-2.5">
                            <span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500"></span>
                        </span>
                        <span class="text-[10px] font-bold tracking-widest text-red-500 uppercase">En Vivo</span>
                        {% else %}
                        <span class="h-2.5 w-2.5 rounded-full bg-slate-600"></span>
                        <span class="text-[10px] font-bold tracking-widest text-slate-500 uppercase">Offline</span>
                        {% end %}
                    </div>
                    <div class="text-[10px] font-mono text-slate-600">ID: {{ event['id'] }}</div>
                </div>

                <div class="p-6">
                    <h3
                        class="text-xl font-bold text-white mb-1 truncate group-hover:text-indigo-400 transition-colors">
                        {{ event['title'] }}</h3>
                    <div class="flex items-center gap-2 mb-6">
                        <a href="/e/{{ event['slug'] }}/watch" target="_blank"
                            class="text-xs text-slate-500 font-mono hover:text-white transition-colors flex items-center gap-1 group/link">
                            /e/{{ event['slug'] }}
                            <svg class="w-3 h-3 opacity-0 group-hover/link:opacity-100 transition-opacity" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                        </a>

                        <div class="ml-auto flex items-center gap-2">
                            <button onclick="copyToClipboard(window.location.origin + '/e/{{ event['slug'] }}')"
                                class="text-[9px] font-bold text-slate-500 hover:text-indigo-400 uppercase tracking-wider flex items-center gap-1 transition-colors"
                                title="Copiar link de acceso">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                                Acceso
                            </button>
                            <div class="w-px h-3 bg-white/10"></div>
                            <button
                                onclick="copyToClipboard(window.location.origin + '/e/{{ event['slug'] }}/register')"
                                class="text-[9px] font-bold text-slate-500 hover:text-emerald-400 uppercase tracking-wider flex items-center gap-1 transition-colors"
                                title="Copiar link de registro">
                                <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Registro
                            </button>
                        </div>
                    </div>

                    <!-- Action Grid -->
                    <div class="grid grid-cols-3 gap-2 mb-6">
                        <a href="/e/{{ event['slug'] }}/mod" target="_blank"
                            class="bg-navy-800 hover:bg-navy-700 border border-white/5 rounded-lg py-3 flex flex-col items-center justify-center gap-1 transition-all group/btn">
                            <svg class="w-5 h-5 text-slate-400 group-hover/btn:text-indigo-400 transition-colors"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                            <span class="text-[9px] uppercase font-bold text-slate-500">Mod</span>
                        </a>
                        <a href="/e/{{ event['slug'] }}/speaker" target="_blank"
                            class="bg-navy-800 hover:bg-navy-700 border border-white/5 rounded-lg py-3 flex flex-col items-center justify-center gap-1 transition-all group/btn">
                            <svg class="w-5 h-5 text-slate-400 group-hover/btn:text-amber-400 transition-colors"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                            <span class="text-[9px] uppercase font-bold text-slate-500">Speaker</span>
                        </a>
                        <a href="/e/{{ event['slug'] }}/reports" target="_blank"
                            class="bg-navy-800 hover:bg-navy-700 border border-white/5 rounded-lg py-3 flex flex-col items-center justify-center gap-1 transition-all group/btn">
                            <svg class="w-5 h-5 text-slate-400 group-hover/btn:text-emerald-400 transition-colors"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            <span class="text-[9px] uppercase font-bold text-slate-500">Reporte</span>
                        </a>
                    </div>

                    <!-- Footer Controls -->
                    <div class="flex items-center gap-3 pt-4 border-t border-white/5">
                        <button data-event='{{ json_encode(event) }}' onclick='openEditWithData(this)'
                            class="text-xs font-semibold text-slate-400 hover:text-white transition-colors">
                            Configurar
                        </button>
                        <div class="h-4 w-px bg-white/10"></div>
                        <button data-event='{{ json_encode(event) }}' onclick='toggleWithData(this)'
                            class="text-xs font-semibold transition-colors {{ 'text-red-400 hover:text-red-300' if event['is_active'] else 'text-green-400 hover:text-green-300' }}">
                            {{ 'Detener' if event['is_active'] else 'Iniciar' }}
                        </button>

                        <a href="/e/{{ event['slug'] }}/watch" target="_blank"
                            class="ml-auto bg-white text-navy-950 hover:bg-slate-200 text-xs font-bold px-4 py-2 rounded-full transition-all">
                            Abrir
                        </a>
                    </div>
                </div>
            </div>
            {% end %}

            <!-- New Event Card (Empty State) -->
            <button onclick="openModal()"
                class="border-2 border-dashed border-white/5 rounded-2xl flex flex-col items-center justify-center p-8 hover:border-indigo-500/30 hover:bg-white/5 transition-all group h-full min-h-[300px]">
                <div
                    class="w-16 h-16 rounded-full bg-navy-800 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                    <svg class="w-6 h-6 text-slate-500 group-hover:text-indigo-400" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-slate-400 group-hover:text-white mb-1">Crear Evento</h3>
                <p class="text-sm text-slate-600">Configura una nueva transmisión</p>
            </button>
        </div>
    </div>

    <!-- Modal Evento -->
    <div id="event-modal"
        class="fixed inset-0 bg-[#050511]/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-all duration-300">
        <div
            class="bg-navy-900 border border-white/5 max-w-lg w-full rounded-2xl p-8 relative shadow-2xl animate-fade-in">
            <!-- Close Button -->
            <button onclick="closeModal()"
                class="absolute top-6 right-6 text-slate-500 hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <h2 id="modal-title" class="text-2xl font-bold text-white mb-1">Nuevo Evento</h2>
            <p class="text-slate-500 text-sm mb-6">Detalles de la transmisión</p>

            <form id="event-form" class="space-y-5">
                <input type="hidden" id="event-id">

                <div class="space-y-1.5">
                    <label class="text-xs font-bold uppercase tracking-wider text-slate-400">Nombre</label>
                    <input type="text" id="title" placeholder="Ej: Tech Summit 2026" required
                        class="w-full bg-navy-950 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-slate-700 focus:outline-none focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/50 transition-all font-medium">
                </div>

                <div class="space-y-1.5">
                    <label class="text-xs font-bold uppercase tracking-wider text-slate-400">Slug URL</label>
                    <div class="flex">
                        <span
                            class="bg-navy-800 border border-r-0 border-white/10 rounded-l-lg px-3 py-3 text-slate-500 text-sm flex items-center">/e/</span>
                        <input type="text" id="slug" placeholder="tech-summit-2026" required
                            class="w-full bg-navy-950 border border-white/10 rounded-r-lg px-4 py-3 text-white placeholder-slate-700 focus:outline-none focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/50 transition-all font-medium">
                    </div>
                </div>

                <div class="space-y-1.5">
                    <label class="text-xs font-bold uppercase tracking-wider text-slate-400">Video Stream URL</label>
                    <input type="text" id="video_url"
                        value="https://produccionesfast.com/assets/videos/transmisionesfast.mp4"
                        class="w-full bg-navy-950 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-slate-700 focus:outline-none focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/50 transition-all text-sm font-mono text-slate-300">
                </div>

                <!-- Theme Configuration -->
                <div class="space-y-4 border border-white/5 rounded-xl p-4 bg-black/20">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-300 border-b border-white/5 pb-2">
                        Personalización Visual</h3>

                    <!-- Base Accent -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-bold uppercase tracking-wider text-slate-500">Acento
                                (Botones/Links)</label>
                            <div class="flex items-center gap-2">
                                <input type="color" id="theme_color" value="#4f46e5"
                                    class="w-10 h-10 rounded-lg border border-white/10 p-1 cursor-pointer bg-navy-950">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 pt-2">
                        <!-- Header Section -->
                        <div class="space-y-3">
                            <span
                                class="text-[10px] font-bold uppercase tracking-wider text-indigo-400 block">Header</span>
                            <div class="space-y-1.5">
                                <label class="text-[10px] text-slate-500">Fondo</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="header_bg_color" value="#0a0b16"
                                        class="w-8 h-8 rounded border border-white/10 p-0.5 cursor-pointer bg-navy-950">
                                </div>
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-[10px] text-slate-500">Texto</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="header_text_color" value="#cbd5e1"
                                        class="w-8 h-8 rounded border border-white/10 p-0.5 cursor-pointer bg-navy-950">
                                </div>
                            </div>
                        </div>

                        <!-- Body Section -->
                        <div class="space-y-3">
                            <span
                                class="text-[10px] font-bold uppercase tracking-wider text-indigo-400 block">Cuerpo</span>
                            <div class="space-y-1.5">
                                <label class="text-[10px] text-slate-500">Fondo</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="body_bg_color" value="#050511"
                                        class="w-8 h-8 rounded border border-white/10 p-0.5 cursor-pointer bg-navy-950">
                                </div>
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-[10px] text-slate-500">Texto</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="body_text_color" value="#cbd5e1"
                                        class="w-8 h-8 rounded border border-white/10 p-0.5 cursor-pointer bg-navy-950">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-1.5">
                    <div class="flex items-center justify-between">
                        <label class="text-xs font-bold uppercase tracking-wider text-slate-400">Logo del evento</label>
                        <span id="logo-upload-status" class="text-xs text-slate-500 min-h-[1rem]"></span>
                    </div>
                    <div class="flex flex-wrap items-center gap-2">
                        <button type="button" id="logo-upload-trigger"
                            class="bg-navy-800 hover:bg-navy-700 border border-white/10 rounded-full px-4 py-2 text-xs font-bold uppercase tracking-wider text-slate-300 transition-all">
                            Subir imagen
                        </button>
                        <span class="text-[11px] text-slate-500">PNG, JPG o WebP hasta 5 MB.</span>
                    </div>
                    <input type="file" id="logo_upload_input" accept="image/png,image/jpeg,image/webp" class="sr-only">
                    <input type="text" id="logo_url" value="https://produccionesfast.com/assets/img/logo.png"
                        data-default-logo="https://produccionesfast.com/assets/img/logo.png"
                        class="w-full bg-navy-950 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-slate-700 focus:outline-none focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/50 transition-all text-sm font-mono text-slate-300">
                    <div class="flex items-center gap-4 pt-2">
                        <img id="logo-preview" src="https://produccionesfast.com/assets/img/logo.png"
                            alt="Logo del evento"
                            class="w-16 h-16 rounded-lg border border-white/10 object-contain bg-white/5">
                        <p class="text-xs text-slate-500 max-w-sm">Este logo se mostrará en todas las páginas de evento
                            y reportes.</p>
                    </div>
                </div>

                <div class="pt-2">
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <div class="relative">
                            <input type="checkbox" id="is_active" class="peer sr-only">
                            <div
                                class="w-10 h-6 bg-navy-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-300 after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600 peer-checked:after:bg-white">
                            </div>
                        </div>
                        <span class="text-sm font-medium text-slate-400 group-hover:text-white transition-colors">Evento
                            público (Activo)</span>
                    </label>
                </div>

                <div class="flex gap-3 pt-6">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 px-4 py-3 rounded-lg font-bold text-slate-400 hover:text-white hover:bg-white/5 transition-all text-sm">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-3 rounded-lg font-bold transition-all shadow-lg shadow-indigo-600/20 hover:-translate-y-0.5 text-sm">
                        Guardar Evento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById('event-modal');
        const form = document.getElementById('event-form');
        let editingId = null;
        const logoUrlInput = document.getElementById('logo_url');
        const logoUploadInput = document.getElementById('logo_upload_input');
        const logoUploadTrigger = document.getElementById('logo-upload-trigger');
        const logoUploadStatus = document.getElementById('logo-upload-status');
        const logoPreview = document.getElementById('logo-preview');
        const LOGO_MAX_BYTES = 5 * 1024 * 1024;
        const defaultLogoUrl = logoUrlInput.dataset.defaultLogo || logoUrlInput.value || '';
        const themeColorInput = document.getElementById('theme_color');
        const headerBgInput = document.getElementById('header_bg_color');
        const headerTextInput = document.getElementById('header_text_color');
        const bodyBgInput = document.getElementById('body_bg_color');
        const bodyTextInput = document.getElementById('body_text_color');

        const DEFAULT_THEME_COLOR = '#4f46e5';
        const DEFAULT_HEADER_BG = '#0a0b16';
        const DEFAULT_HEADER_TEXT = '#cbd5e1';
        const DEFAULT_BODY_BG = '#050511';
        const DEFAULT_BODY_TEXT = '#cbd5e1';

        function updateLogoPreview(source) {
            logoPreview.src = source || defaultLogoUrl;
        }

        function setLogoStatus(message = '', tone = '') {
            logoUploadStatus.textContent = message;
            logoUploadStatus.classList.remove('text-emerald-400', 'text-amber-400', 'text-red-400', 'text-slate-500');
            if (!message) {
                logoUploadStatus.classList.add('text-slate-500');
                return;
            }
            const toneClass = tone === 'success' ? 'text-emerald-400' : tone === 'error' ? 'text-red-400' : 'text-amber-400';
            logoUploadStatus.classList.add(toneClass);
        }

        function resetLogoState() {
            setLogoStatus();
            updateLogoPreview(logoUrlInput.value || defaultLogoUrl);
        }

        function resetThemeColor() {
            if (themeColorInput) themeColorInput.value = DEFAULT_THEME_COLOR;
            if (headerBgInput) headerBgInput.value = DEFAULT_HEADER_BG;
            if (headerTextInput) headerTextInput.value = DEFAULT_HEADER_TEXT;
            if (bodyBgInput) bodyBgInput.value = DEFAULT_BODY_BG;
            if (bodyTextInput) bodyTextInput.value = DEFAULT_BODY_TEXT;
        }

        async function uploadLogoAsset(file) {
            const payload = new FormData();
            payload.append('logo', file);
            setLogoStatus('Subiendo logo...', 'neutral');
            try {
                const res = await fetch('/api/admin/events/logo', {
                    method: 'POST',
                    body: payload,
                });
                const data = await res.json();
                if (!res.ok) {
                    throw new Error(data.message || 'No fue posible subir el archivo.');
                }
                logoUrlInput.value = data.logo_url;
                updateLogoPreview(data.logo_url);
                setLogoStatus('Logo cargado', 'success');
            } catch (err) {
                setLogoStatus('No se pudo subir', 'error');
                showToast('No se pudo subir el logo.', 'error');
            }
        }

        logoUploadTrigger.addEventListener('click', () => logoUploadInput.click());
        logoUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > LOGO_MAX_BYTES) {
                setLogoStatus('El archivo supera 5 MB', 'error');
                showToast('El logo supera el tamaño permitido.', 'error');
                logoUploadInput.value = '';
                return;
            }
            await uploadLogoAsset(file);
            logoUploadInput.value = '';
        });

        logoUrlInput.addEventListener('input', () => updateLogoPreview(logoUrlInput.value || defaultLogoUrl));

        function openModal() {
            editingId = null;
            form.reset();
            document.getElementById('modal-title').textContent = "Nuevo Evento";
            resetLogoState();
            document.getElementById('slug').disabled = false;
            document.getElementById('is_active').checked = true;
            resetThemeColor();
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function editEvent(event) {
            editingId = event.id;
            document.getElementById('modal-title').textContent = "Editar Evento";
            document.getElementById('event-id').value = event.id;
            document.getElementById('title').value = event.title;
            document.getElementById('slug').value = event.slug;
            document.getElementById('slug').disabled = true;
            document.getElementById('video_url').value = event.video_url;
            const logoValue = event.logo_url || defaultLogoUrl;

            if (themeColorInput) themeColorInput.value = event.theme_color || DEFAULT_THEME_COLOR;
            if (headerBgInput) headerBgInput.value = event.header_bg_color || DEFAULT_HEADER_BG;
            if (headerTextInput) headerTextInput.value = event.header_text_color || DEFAULT_HEADER_TEXT;
            if (bodyBgInput) bodyBgInput.value = event.body_bg_color || DEFAULT_BODY_BG;
            if (bodyTextInput) bodyTextInput.value = event.body_text_color || DEFAULT_BODY_TEXT;

            setLogoStatus();
            const themeValue = event.theme_color || DEFAULT_THEME_COLOR;
            if (themeColorInput) themeColorInput.value = themeValue;
            document.getElementById('is_active').checked = event.is_active;
            modal.classList.remove('hidden');
        }

        function openEditWithData(btn) {
            const data = JSON.parse(btn.getAttribute('data-event'));
            editEvent(data);
        }

        async function toggleEventStatus(event) {
            const current_status = event.is_active;
            const action = current_status ? 'Finalizar' : 'Iniciar';
            const actionText = current_status ? 'cerrar' : 'activar';

            const result = await Swal.fire({
                title: `¿${action} transmisión?`,
                text: `Estás a punto de ${actionText} el evento "${event.title}". ${current_status ? 'Los usuarios ya no podrán ver el stream.' : 'Será visible para todos.'}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: current_status ? '#ef4444' : '#10b981',
                cancelButtonColor: '#1f2937',
                confirmButtonText: `Sí, ${actionText}`,
                cancelButtonText: 'Cancelar',
                background: '#0a0b16',
                color: '#e2e8f0',
                customClass: {
                    popup: 'border border-white/10 rounded-2xl'
                }
            });

            if (!result.isConfirmed) return;

            try {
                const res = await fetch('/api/admin/events', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: event.id,
                        title: event.title,
                        slug: event.slug,
                        video_url: event.video_url,
                        logo_url: event.logo_url,
                        theme_color: event.theme_color,
                        header_bg_color: event.header_bg_color,
                        header_text_color: event.header_text_color,
                        body_bg_color: event.body_bg_color,
                        body_text_color: event.body_text_color,
                        is_active: current_status ? 0 : 1
                    })
                });

                if (res.ok) {
                    await Swal.fire({
                        title: '¡Hecho!',
                        text: 'El estado del evento ha sido actualizado.',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false,
                        background: '#0a0b16',
                        color: '#e2e8f0'
                    });
                    location.reload();
                } else {
                    throw new Error('Server responded properly but with error status');
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: 'No se pudo actualizar el evento. Intenta de nuevo.',
                    icon: 'error',
                    background: '#0a0b16',
                    color: '#e2e8f0',
                    confirmButtonColor: '#4f46e5'
                });
            }
        }

        form.onsubmit = async (e) => {
            e.preventDefault();

            // Validations
            const title = document.getElementById('title').value;
            const slug = document.getElementById('slug').value;

            if (!title || !slug) {
                showToast('Por favor completa los campos obligatorios.', 'error');
                return;
            }

            const payload = {
                title: title,
                slug: slug,
                video_url: document.getElementById('video_url').value,
                logo_url: document.getElementById('logo_url').value,
                theme_color: themeColorInput ? themeColorInput.value : DEFAULT_THEME_COLOR,
                header_bg_color: headerBgInput ? headerBgInput.value : DEFAULT_HEADER_BG,
                header_text_color: headerTextInput ? headerTextInput.value : DEFAULT_HEADER_TEXT,
                body_bg_color: bodyBgInput ? bodyBgInput.value : DEFAULT_BODY_BG,
                body_text_color: bodyTextInput ? bodyTextInput.value : DEFAULT_BODY_TEXT,
                is_active: document.getElementById('is_active').checked ? 1 : 0
            };

            const method = editingId ? 'PUT' : 'POST';
            if (editingId) payload.id = editingId;

            try {
                const res = await fetch('/api/admin/events', {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.status === 401) {
                    window.location.reload();
                    return;
                }

                if (res.ok) {
                    showToast('Evento guardado correctamente.', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Ocurrió un error al guardar el evento.', 'error');
                }
            } catch (err) {
                showToast('Error de conexión con el servidor.', 'error');
            }
        };

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
        });

        function copyToClipboard(text) {
            if (!navigator.clipboard) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('Enlace copiado con éxito', 'success');
                } catch (err) {
                    showToast('No se pudo copiar', 'error');
                }
                document.body.removeChild(textArea);
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                showToast('Enlace copiado con éxito', 'success');
            }).catch(err => {
                showToast('Error al copiar', 'error');
            });
        }
    </script>
    <script>
        // Heartbeat for Admin Session (5 mins TTL)
        setInterval(() => {
            fetch('/api/ping', { method: 'POST' })
                .then(res => {
                    if (res.status === 401) window.location.reload();
                })
                .catch(() => { });
        }, 60000);
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage Monitor · {{ user_name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        navy: {
                            950: '#050511',
                            900: '#0a0b16',
                            800: '#151725',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050511;
        }

        .scroll-area::-webkit-scrollbar {
            width: 0px;
        }

        .animate-in {
            animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes highlight {
            0% {
                transform: scale(0.95);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Add slow spin animation */
        @keyframes spin-slow {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin-slow {
            animation: spin-slow 3s linear infinite;
        }

        .new-highlight {
            animation: highlight 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* Portrait Mode Warning for Mobile/Tablet */
        #landscape-warning {
            display: none;
        }

        @media screen and (orientation: portrait) and (max-width: 1024px) {
            #landscape-warning {
                display: flex !important;
            }

            #main-content {
                display: none !important;
            }
        }
    </style>
    {% include "includes/theme.html" %}
</head>

<body class="bg-[#050511] text-slate-100 min-h-screen overflow-hidden">
    <!-- Landscape Warning Overlay -->
    <div id="landscape-warning"
        class="fixed inset-0 z-[100] bg-[#050511] flex-col items-center justify-center p-8 text-center">
        <div class="relative w-24 h-24 mb-6">
            <svg class="w-full h-full text-indigo-500 animate-spin-slow" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </div>
        </div>
        <h2 class="text-3xl font-black text-white mb-3">Gira tu dispositivo</h2>
        <p class="text-slate-400 max-w-xs mx-auto text-sm leading-relaxed">
            Para la mejor experiencia como Speaker, por favor utiliza el modo horizontal (landscape).
        </p>
    </div>

    <div id="main-content" class="h-screen flex flex-col p-3 lg:p-5 relative text-white overflow-hidden">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl h-64 bg-indigo-500/10 blur-[120px] -z-10">
        </div>

        <!-- Ultra-compact header -->
        <header class="flex items-center justify-between mb-2 lg:mb-4 animate-in shrink-0 h-10 lg:h-auto">
            <div class="flex items-center gap-3">
                <img src="{{ event['logo_url'] if event and event.get('logo_url') else 'https://produccionesfast.com/assets/img/logo.png' }}"
                    alt="Logo" class="h-5 lg:h-8 w-auto">
                <div class="h-4 w-px bg-white/10 hidden sm:block"></div>
                <div class="flex items-center gap-1.5">
                    <span class="relative flex h-2 w-2">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                    </span>
                    <span class="text-[8px] font-bold tracking-widest text-red-500 uppercase">EN VIVO</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                {% include "includes/theme_switcher.html" %}
                <a href="/logout"
                    class="bg-white/5 hover:bg-white/10 p-1.5 lg:p-3 rounded-lg border border-white/10 transition-all">
                    <svg class="w-4 h-4 lg:w-5 lg:h-5 text-slate-400" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                </a>
            </div>
        </header>

        <!-- Main content: Question left, Queue right -->
        <main class="flex-1 flex flex-row gap-3 lg:gap-8 overflow-hidden min-h-0">
            <!-- Left: Current Question (takes most space) -->
            <div class="flex-[3] flex flex-col min-w-0 min-h-0">
                <p
                    class="text-[9px] lg:text-xs font-black text-indigo-500 uppercase tracking-widest mb-1 lg:mb-3 shrink-0">
                    Pregunta Actual</p>
                <div id="current-question-container"
                    class="flex-1 flex flex-col justify-center overflow-y-auto min-h-0">
                    <div class="opacity-20">
                        <h2 class="text-2xl lg:text-6xl font-black text-white leading-tight">Esperando<br>pregunta...
                        </h2>
                    </div>
                </div>
            </div>

            <!-- Right: Queue (narrow sidebar) -->
            <div
                class="w-[180px] lg:w-[280px] flex flex-col bg-white/[0.03] border border-white/5 rounded-xl lg:rounded-2xl p-2 lg:p-4 shrink-0">
                <div class="flex items-center justify-between mb-2 shrink-0">
                    <span
                        class="text-[8px] lg:text-[10px] font-bold uppercase tracking-wider text-slate-500">Cola</span>
                    <span id="queue-count"
                        class="bg-indigo-500/20 text-indigo-400 text-[9px] font-black px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="speaker-questions" class="flex-1 overflow-y-auto space-y-2 scroll-area min-h-0">
                    {% for question in approved_questions %}
                    <div class="p-2 lg:p-3 rounded-lg bg-white/5 border border-white/5 opacity-60 hover:opacity-100 cursor-pointer transition-all"
                        onclick="highlightManual('{{ question.get('id', '') }}')" data-id="{{ question.get('id', '') }}"
                        data-user="{{ question.get('user_name', '') }}"
                        data-question="{{ question.get('question_text', '') }}"
                        data-timestamp="{{ question.get('created_at', '') }}">
                        <p class="text-[8px] lg:text-[9px] font-bold text-indigo-400 uppercase tracking-wide mb-0.5">{{
                            question.get('user_name', '') }}</p>
                        <p class="text-[11px] lg:text-sm text-slate-300 leading-snug line-clamp-2">{{
                            question.get('question_text', '') }}</p>
                    </div>
                    {% end %}
                </div>
            </div>
        </main>
    </div>

    <script>
        // Dynamically determine protocol (ws or wss) based on page loading environment
        const baseWsUrl = "{% raw ws_url %}";
        const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const finalWsUrl = baseWsUrl.replace(/^ws(s)?:\/\//, wsProtocol);
        let ws = null;
        let wsReconnectAttempt = 0;
        let wsReconnectTimer = null;
        const list = document.getElementById("speaker-questions");
        const currentContainer = document.getElementById("current-question-container");
        const queueCount = document.getElementById("queue-count");

        let currentActiveId = null;
        let wsConnected = false;

        function handleWsMessage(event) {
            const payload = JSON.parse(event.data);
            console.log("WS Message:", payload.type, payload);

            if (payload.type === "approved_question") {
                const div = document.createElement("div");
                div.className = "p-6 rounded-2xl bg-white/5 border border-white/5 animate-in group cursor-pointer";
                div.dataset.id = payload.id;
                div.dataset.user = payload.user;
                div.dataset.question = payload.question;
                div.dataset.timestamp = payload.timestamp;
                div.onclick = () => highlightManual(payload.id);
                div.innerHTML = `
                    <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-2">${payload.user}</p>
                    <p class="text-lg text-slate-200 font-medium leading-relaxed">${payload.question}</p>
                `;
                list.prepend(div);
                if (!currentActiveId) {
                    updateCurrent(payload);
                } else {
                    syncQueueList();
                }
            } else if (payload.type === "question_read" || payload.type === "question_removed") {
                const el = list.querySelector(`[data-id="${payload.id}"]`);
                if (el) el.remove();

                if (currentActiveId == payload.id) {
                    updateNextInQueue();
                } else {
                    syncQueueList();
                }
            } else if (payload.type === "event_closed") {
                window.location.href = "/?error=" + encodeURIComponent("Esta transmisión ha finalizado.");
            }
        }

        function connectWs() {
            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return;
            if (wsReconnectTimer) {
                clearTimeout(wsReconnectTimer);
                wsReconnectTimer = null;
            }

            ws = new WebSocket(finalWsUrl);

            ws.addEventListener("open", () => {
                console.log("✓ Speaker WebSocket Connected");
                wsConnected = true;
                wsReconnectAttempt = 0;
            });

            ws.addEventListener("message", handleWsMessage);

            ws.addEventListener("close", (e) => {
                console.log("✗ Speaker WebSocket Closed:", e.code, e.reason);
                wsConnected = false;

                // Reload only if the server indicates session expired
                if (e && e.code === 4001) {
                    window.location.reload();
                    return;
                }

                wsReconnectAttempt += 1;
                const delay = Math.min(30000, 1000 * Math.pow(2, Math.min(wsReconnectAttempt, 5)));
                wsReconnectTimer = setTimeout(connectWs, delay);
            });

            ws.addEventListener("error", (e) => {
                console.error("✗ Speaker WebSocket Error:", e);
                wsConnected = false;
            });
        }

        connectWs();

        // Heartbeat / Keep-Alive System (5-min session fix)
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "ping" }));
                return;
            }
            fetch(`/api/ping?event_id={{ event['id'] }}`,
                { method: 'POST', headers: { 'Content-Type': 'application/json' } }
            ).then(res => {
                if (res.status === 401) window.location.reload();
            }).catch(() => { });
        }, 60000); // Ping every 60s

        function updateCurrent(payload) {
            currentActiveId = payload.id;
            currentContainer.innerHTML = `
                <div class="new-highlight h-full flex flex-col">
                    <!-- Compact header with user info and actions -->
                    <div class="flex items-center justify-between mb-2 lg:mb-4 shrink-0">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 lg:w-10 lg:h-10 rounded-full bg-indigo-500 flex items-center justify-center text-xs lg:text-sm font-bold">
                                ${payload.user.slice(0, 2).toUpperCase()}
                            </div>
                            <div>
                                <p class="text-sm lg:text-base font-bold text-white">${payload.user}</p>
                                <p class="text-[8px] lg:text-[10px] text-slate-400">${payload.timestamp}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="returnToModerator(${payload.id})" 
                                class="bg-amber-500/10 hover:bg-amber-500/20 text-amber-500 px-2 lg:px-3 py-1.5 rounded-lg text-[9px] lg:text-[10px] font-bold flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                                <span class="hidden sm:inline">REGRESAR</span>
                            </button>
                            <button onclick="markAsRead(${payload.id})" 
                                class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 lg:px-4 py-1.5 rounded-lg text-[9px] lg:text-[10px] font-bold flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                LEÍDA
                            </button>
                        </div>
                    </div>
                    <!-- Question text (scrollable if needed) -->
                    <div class="flex-1 overflow-y-auto min-h-0">
                        <h2 class="text-xl sm:text-2xl lg:text-5xl font-black text-white leading-tight">
                            ${payload.question}
                        </h2>
                    </div>
                </div>
            `;
            syncQueueList();
        }

        function syncQueueList() {
            const items = list.querySelectorAll("[data-id]");
            let visibleCount = 0;
            items.forEach(el => {
                if (el.dataset.id == currentActiveId) {
                    el.classList.add("hidden");
                } else {
                    el.classList.remove("hidden");
                    visibleCount++;
                }
            });
            queueCount.innerText = visibleCount;
        }

        function markAsRead(id) {
            if (!wsConnected) {
                console.error("Cannot send: WebSocket not connected");
                alert("Conexión perdida. Reintentando conexión...");
                connectWs();
                return;
            }
            console.log("Sending read for id:", id);
            ws.send(JSON.stringify({ type: "read", id: parseInt(id) }));
        }

        function returnToModerator(id) {
            if (!wsConnected) {
                console.error("Cannot send: WebSocket not connected");
                alert("Conexión perdida. Reintentando conexión...");
                connectWs();
                return;
            }
            console.log("Sending return_to_moderator for id:", id);
            ws.send(JSON.stringify({ type: "return_to_moderator", id: parseInt(id) }));
        }

        function highlightManual(id) {
            const el = list.querySelector(`[data-id="${id}"]`);
            if (!el) return;
            updateCurrent({
                id: id,
                user: el.dataset.user,
                question: el.dataset.question,
                timestamp: el.dataset.timestamp
            });
        }

        function updateNextInQueue() {
            const items = Array.from(list.querySelectorAll("[data-id]"));
            if (items.length > 0) {
                const first = items[0];
                updateCurrent({
                    id: first.dataset.id,
                    user: first.dataset.user,
                    question: first.dataset.question,
                    timestamp: first.dataset.timestamp
                });
            } else {
                currentActiveId = null;
                currentContainer.innerHTML = `
                    <div class="opacity-10 py-20">
                        <h2 class="text-6xl lg:text-8xl font-black text-white leading-tight">Sin<br>preguntas</h2>
                    </div>
                `;
                queueCount.innerText = 0;
            }
        }



        // Initial setup
        updateNextInQueue();
    </script>
</body>

</html>